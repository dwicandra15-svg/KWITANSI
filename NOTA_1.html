<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kwitansi Offline</title>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{--accent:#0b74da;--muted:#666}
body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;line-height:1.4;margin:16px;background:#f5f7fb;color:#222}
.container{max-width:980px;margin:0 auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 6px 20px rgba(2,12,34,.08)}
.panel{padding:12px;border:1px dashed #e6eef9;border-radius:10px;background:#fbfdff}
label{display:block;font-size:13px;color:#666;margin-bottom:6px}
input[type=text], input[type=number], textarea, select, input[type=date]{width:100%;padding:8px;border:1px solid #e1e6ef;border-radius:8px}
table{width:100%;border-collapse:collapse;margin-top:8px}table th, table td{padding:8px;border:1px solid #edf2f8;font-size:14px}table th{background:#f3f8ff}
.btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}.btn-primary{background:#0b74da;color:#fff}.btn-ghost{background:#fff;border:1px solid #d6e6ff;color:#0b74da}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:14px}
.receipts-list{max-height:200px;overflow:auto;border:1px solid #eef3fb;padding:8px;border-radius:8px}
.receipt-item{padding:8px;margin-bottom:6px;background:#fff;border-radius:8px;border:1px solid #f1f6fc;display:flex;justify-content:space-between}
#preview{position:relative;background:#fff;padding:20px;border-radius:8px;min-height:160px}
#preview #watermark{position:absolute;top:260px;left:50%;transform:translate(-50%,0);font-size:90px;font-weight:900;color:rgba(255,0,0,0.15);pointer-events:none;z-index:0}
.signature{height:140px;border-bottom:1px solid #aaa;margin-top:12px}
@media print{#preview #watermark{font-size:120px;opacity:0.12}}
.modal{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:90%;max-width:820px;background:#fff;padding:18px;border-radius:10px;box-shadow:0 12px 30px rgba(0,0,0,0.2);z-index:9999}
.modal.show{display:block}
.modal .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
</style>
</head>
<body>

<!-- KOP OPTIONAL - POSISI DIPERBAIKI -->
<div id="kop" style="display:none;text-align:center;margin-bottom:12px;font-weight:700;font-size:16px;line-height:1.6">
  CATERING ASIYA<br>
  <span style="font-weight:400;font-size:14px">Jl. RAJAWALI 1 KECAMATAN SAMPANG</span>
</div>
<select id="kop_toggle" style="margin-bottom:10px">
  <option value="off">Kop OFF</option>
  <option value="on">Kop ON</option>
</select>

<div class="container">
  <h2 style="margin:0 0 12px">Kwitansi</h2>
  <div class="flex" style="display:flex;gap:16px">
    <div style="flex:1;min-width:360px">
      <div class="panel">
        <div style="display:flex;gap:12px">
          <div style="flex:1">
            <label>No. Kwitansi</label>
            <input id="no" type="text" placeholder="AUTO atau isi manual">
          </div>
          <div style="width:160px">
            <label>Tanggal</label>
            <input id="tanggal" type="date">
            <select id="date_format" style="margin-top:6px">
              <option value="dd-mm-yyyy">dd-mm-yyyy</option>
              <option value="dd/mm/yyyy">dd/mm/yyyy</option>
              <option value="yyyy/mm/dd">yyyy/mm/dd</option>
            </select>
          </div>
        </div>

        <label>Terima dari</label>
        <input id="terima_dari" type="text">
        <label>Untuk pembayaran</label>
        <textarea id="keterangan"></textarea>
        <label>Metode Pembayaran</label>
        <select id="metode"><option>Tunai</option><option>Transfer</option><option>Cek</option></select>

        <label style="margin-top:10px">Item Pembelian</label>
        <table id="items-table"><thead><tr><th style="width:6%">#</th><th>Deskripsi</th><th style="width:14%">Qty</th><th style="width:18%">Harga</th><th style="width:18%">Jumlah</th><th style="width:6%"></th></tr></thead><tbody></tbody></table>
        <button id="btn-add-item" class="btn btn-ghost" style="margin-top:8px">+ Tambah Item</button>

        <div style="display:flex;justify-content:flex-end;margin-top:12px"><div class="small">Subtotal &nbsp;</div><div id="subtotal" style="font-weight:700">Rp 0</div></div>
        <div style="display:flex;justify-content:flex-end;margin-top:6px;gap:6px"><div class="small">Pajak (%)</div><input id="pajak" type="number" min="0" value="0" style="width:70px"></div>
        <div style="display:flex;justify-content:flex-end;margin-top:6px"><div class="small">TOTAL &nbsp;</div><div id="total" style="font-weight:900;font-size:18px">Rp 0</div></div>

        <label style="margin-top:10px">Terbilang</label>
        <input id="terbilang" type="text" readonly>
        <label style="margin-top:10px">Catatan</label>
        <textarea id="notes"></textarea>
      </div>

      <div class="controls">
        <button id="btn-save" class="btn btn-primary">Simpan</button>
        <button id="btn-new" class="btn">Baru</button>
        <select id="watermark_toggle"><option value="off">Watermark OFF</option><option value="on">Watermark ON</option></select>
        <input id="watermark_text" type="text" value="LUNAS" style="width:120px">
        <button id="btn-print" class="btn btn-ghost">Export PDF</button>
        <button id="btn-download" class="btn">Backup JSON</button>
        <button id="btn-invoice" class="btn btn-primary">Invoice</button>
      </div>
    </div>

    <div style="width:320px"><label>Daftar Kwitansi</label><div id="receipts-list" class="receipts-list"></div></div>
  </div>

  <div style="margin-top:20px;padding:14px;background:#fbfdff;border-radius:10px;border:1px solid #e6f0ff"><h3>Preview</h3><div id="preview"></div></div>
</div>

<!-- INVOICE MODAL -->

<!-- KOP INVOICE OPTIONAL -->
<div style="margin-bottom:10px">
  <label style="font-weight:600">Kop Invoice</label>
  <textarea id="invoice_kop" style="width:100%;min-height:60px;border:1px solid #ccc;border-radius:8px">CATERING ASIYA
Jl. RAJAWALI 1 KECAMATAN SAMPANG</textarea>
  <select id="invoice_kop_toggle" style="margin-top:6px">
    <option value="off">Kop Invoice OFF</option>
    <option value="on">Kop Invoice ON</option>
  </select>
</div>

<!-- INVOICE MODAL -->
<div id="invoice-page" class="modal" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h2 style="margin:0">INVOICE</h2>
    <div>
      <button id="invoice-close" class="btn">Tutup</button>
      <button id="invoice-print" class="btn btn-primary">Print Invoice</button>
    </div>
  </div>

  <div style="margin-top:10px;display:flex;gap:12px">
    <div style="flex:1">
      <label>Invoice Tanggal</label>
      <input id="invoice_tanggal" type="date">
    </div>
    <div style="width:160px">
      <label>Format Tanggal</label>
      <select id="invoice_date_format"><option value="dd-mm-yyyy">dd-mm-yyyy</option><option value="dd/mm/yyyy">dd/mm/yyyy</option><option value="yyyy/mm/dd">yyyy/mm/dd</option></select>
    </div>
  </div>

  <label style="margin-top:8px">Kepada</label>
  <input id="invoice_to" type="text">

  <label style="margin-top:8px">Rincian Barang (Invoice)</label>
  <table id="invoice-items-table" style="width:100%"><thead><tr><th style="width:6%">#</th><th>Deskripsi</th><th style="width:14%">Qty</th><th style="width:18%">Harga</th><th style="width:18%">Jumlah</th><th style="width:6%"></th></tr></thead><tbody></tbody></table>
  <div style="margin-top:8px"><button id="btn-invoice-add-item" class="btn btn-ghost">+ Tambah Detail Barang</button></div>

  <div class="modal-actions">
    <div style="flex:1"></div>
    <div>
      <button id="invoice-save" class="btn btn-primary">Simpan Invoice</button>
    </div>
  </div>
</div>

<script>
/* ----------------------- Global storage & helpers ----------------------- */
let receipts = [];
const KEY = 'kwitansi_store_v1';

function escapeHtml(s){return String(s||'').replace(/[&"'<>]/g,c=>({"&":"&amp;","\"":"&quot;","'":"&#39;","<":"&lt;",">":"&gt;"}[c]))}
function formatRp(n){return 'Rp ' + Number(n||0).toLocaleString('id-ID')}
function terbilang(n){n=Math.floor(Number(n)||0);if(n===0) return 'nol';const s=['','satu','dua','tiga','empat','lima','enam','tujuh','delapan','sembilan','sepuluh','sebelas'];function w(x){x=Math.floor(x);if(x<12) return s[x]; if(x<20) return w(x-10)+ ' belas'; if(x<100) return w(Math.floor(x/10)) + ' puluh' + (x%10? ' ' + w(x%10):''); if(x<200) return 'seratus' + (x%100? ' ' + w(x%100):''); if(x<1000) return w(Math.floor(x/100)) + ' ratus' + (x%100? ' ' + w(x%100):''); if(x<2000) return 'seribu' + (x%1000? ' ' + w(x%1000):''); if(x<1000000) return w(Math.floor(x/1000)) + ' ribu' + (x%1000? ' ' + w(x%1000):''); if(x<1000000000) return w(Math.floor(x/1000000)) + ' juta' + (x%1000000? ' ' + w(x%1000000):''); return x;} return w(n).trim();}

function formatDateISOTo(d, fmt){ if(!d) return ''; const parts = d.split('-'); if(parts.length!==3) return d; const [y,m,dd] = parts; if(fmt==='dd-mm-yyyy') return `${dd}-${m}-${y}`; if(fmt==='dd/mm/yyyy') return `${dd}/${m}/${y}`; if(fmt==='yyyy/mm/dd') return `${y}/${m}/${dd}`; return d; }

/* ----------------------- Items (main kwitansi) ----------------------- */
function addItem(desc='', qty=1, price=0){
  const tbody = document.querySelector('#items-table tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td class="small"></td>
    <td><input class="item-desc" type="text" value="${escapeHtml(desc)}" placeholder="Deskripsi"></td>
    <td><input class="item-qty" type="number" min="1" value="${qty}"></td>
    <td><input class="item-price" type="number" min="0" value="${price}"></td>
    <td class="item-sum">Rp 0</td>
    <td><button type="button" class="btn" data-remove>×</button></td>
  `;
  tbody.appendChild(tr);
  attachEvents(tr);
  reindex();
  recalc();
}
function attachEvents(tr){ tr.querySelectorAll('input').forEach(i=>i.addEventListener('input', ()=>{ updateRow(tr); recalc(); })); const b = tr.querySelector('[data-remove]'); if(b) b.addEventListener('click', ()=>{ tr.remove(); reindex(); recalc(); }); }
function updateRow(tr){ const q = Number(tr.querySelector('.item-qty').value||0); const p = Number(tr.querySelector('.item-price').value||0); const sumEl = tr.querySelector('.item-sum'); sumEl.textContent = formatRp(q*p); }
function reindex(){ document.querySelectorAll('#items-table tbody tr').forEach((r,i)=> r.children[0].textContent = i+1); }

/* ----------------------- calculations & preview ----------------------- */
function recalc(){ let subtotal = 0; document.querySelectorAll('#items-table tbody tr').forEach(r=>{ const q = Number(r.querySelector('.item-qty').value||0); const p = Number(r.querySelector('.item-price').value||0); subtotal += q*p; }); document.getElementById('subtotal').textContent = formatRp(subtotal); const pajak = Number(document.getElementById('pajak').value||0); const total = Math.round(subtotal * (1 + pajak/100)); document.getElementById('total').textContent = formatRp(total); document.getElementById('terbilang').value = terbilang(total) + ' rupiah'; renderPreview(); }

function renderPreview(){
  const p = document.getElementById('preview');
  const no = document.getElementById('no').value;
  const tanggal = document.getElementById('tanggal').value;
  const dateFmt = document.getElementById('date_format')?.value || 'dd-mm-yyyy';
  const tanggalText = formatDateISOTo(tanggal,dateFmt);
  const nama = document.getElementById('terima_dari').value;
  const ket = document.getElementById('keterangan').value;
  const pajak = Number(document.getElementById('pajak').value||0);
  const notes = document.getElementById('notes').value;

  let rows = '';
  let subtotalNum = 0;
  document.querySelectorAll('#items-table tbody tr').forEach((r,i)=>{
    const desc = r.querySelector('.item-desc')?.value || '';
    const qty = Number(r.querySelector('.item-qty')?.value||0);
    const price = Number(r.querySelector('.item-price')?.value||0);
    const sum = qty*price;
    subtotalNum += sum;
    rows += `<tr><td>${i+1}</td><td>${escapeHtml(desc)}</td><td>${qty}</td><td>${formatRp(price)}</td><td>${formatRp(sum)}</td></tr>`;
  });

  const subtotalText = formatRp(subtotalNum);
  const totalNum = Math.round(subtotalNum*(1 + pajak/100));
  const totalText = formatRp(totalNum);
  const terbil = terbilang(totalNum) + ' rupiah';

  const kopOn = document.getElementById('kop_toggle')?.value === 'on';
  const kopHtml = kopOn ? `<div style="text-align:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;line-height:1.4">CATERING ASIYA</div><div style="font-weight:400;font-size:14px;line-height:1.4">Jl. RAJAWALI 1 KECAMATAN SAMPANG</div></div>` : '';

  const html = `
    <div style="max-width:700px;margin:0 auto;position:relative;z-index:1;font-family:system-ui">
      ${kopHtml}
      <div style="display:flex;justify-content:space-between">
        <div>
          <div style="font-size:18px;font-weight:700">KWITANSI</div>
          <div class="small">No: ${escapeHtml(no||'(Otomatis)')}</div>
        </div>
        <div class="small" style="text-align:right">
          Tanggal: ${escapeHtml(tanggalText)}<br>
          Metode: ${escapeHtml(document.getElementById('metode').value)}
        </div>
      </div>

      <div style="margin-top:10px">
        <div class="small">Telah terima dari:</div>
        <div style="font-weight:600">${escapeHtml(nama)}</div>
        <div>Untuk pembayaran: ${escapeHtml(ket)}</div>
      </div>

      <table style="margin-top:12px">
        <thead><tr><th>No</th><th>Deskripsi</th><th>Qty</th><th>Harga</th><th>Jumlah</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>

      <div style="display:flex;justify-content:flex-end;margin-top:10px"><div class="small">Subtotal</div>&nbsp;<div style="font-weight:700">${subtotalText}</div></div>
      <div style="display:flex;justify-content:flex-end"><div class="small">Pajak (${pajak}%)</div>&nbsp;<div style="font-weight:700">${formatRp(Math.round(subtotalNum * (pajak/100)))}</div></div>
      <div style="display:flex;justify-content:flex-end;margin-top:4px"><div class="small">TOTAL</div>&nbsp;<div style="font-weight:900;font-size:18px">${totalText}</div></div>

      <div style="margin-top:10px">Terbilang: <i>${escapeHtml(terbil)}</i></div>

      <div style="display:flex;justify-content:space-between;margin-top:24px">
        <div style="width:60%"><div class="small">Catatan:</div><div style="min-height:40px">${escapeHtml(notes||"")}</div></div>
        <div style="width:35%;text-align:center"><div class="small">Penerima</div><div class="signature"></div>(___________________)</div>
      </div>
    </div>
  `;

  let wm = '';
  if(document.getElementById('watermark_toggle')?.value === 'on'){
    wm = `<div id="watermark">${escapeHtml(document.getElementById('watermark_text')?.value||'')}</div>`;
  }

  p.innerHTML = html + wm;
}

function toggleKop(){ const kop=document.getElementById('kop'); kop.style.display=document.getElementById('kop_toggle').value==='on'?'block':'none'; }

/* ----------------------- export PDF (preview -> image -> pdf) ----------------------- */
async function exportPDF(){
  const { jsPDF } = window.jspdf;
  const previewEl = document.getElementById('preview');
  renderPreview();
  const canvas = await html2canvas(previewEl, {scale:2,useCORS:true});
  const img = canvas.toDataURL('image/png');
  const pdf = new jsPDF('p','mm','a4');
  const w = 210; const h = (canvas.height * w) / canvas.width;
  pdf.addImage(img,'PNG',0,0,w,h);
  pdf.save('kwitansi.pdf');
}

/* ----------------------- storage (save/load receipts) ----------------------- */
function loadReceipts(){ try{ const raw = localStorage.getItem(KEY); return raw?JSON.parse(raw):[]; }catch(e){ return []; } }
function saveAll(){ localStorage.setItem(KEY, JSON.stringify(receipts)); renderList(); }
function saveData(){ let no=document.getElementById('no').value; if(!no) no='KW-'+Date.now(); const data={ id: Date.now(), no:no, tanggal:document.getElementById('tanggal').value, terima_dari:document.getElementById('terima_dari').value, keterangan:document.getElementById('keterangan').value, metode:document.getElementById('metode').value, pajak:Number(document.getElementById('pajak').value||0), notes:document.getElementById('notes').value, items:Array.from(document.querySelectorAll('#items-table tbody tr')).map(r=>({desc:r.querySelector('.item-desc').value, qty: Number(r.querySelector('.item-qty').value||0), price: Number(r.querySelector('.item-price').value||0) })) };
  receipts.unshift(data); saveAll(); resetForm(); alert('Kwitansi tersimpan'); }

function renderList(){ const box=document.getElementById('receipts-list'); box.innerHTML=''; receipts.forEach(r=>{ const div=document.createElement('div'); div.className='receipt-item'; const left=document.createElement('div'); left.innerHTML=`<div style="font-weight:600">${escapeHtml(r.no)}</div><div class="small">${escapeHtml(r.terima_dari||'')}</div>`; const openBtn=document.createElement('button'); openBtn.className='btn'; openBtn.textContent='Buka'; openBtn.addEventListener('click', ()=> openData(r.id)); const delBtn=document.createElement('button'); delBtn.className='btn'; delBtn.textContent='Hapus'; delBtn.addEventListener('click', ()=>{ if(confirm('Hapus kwitansi ini?')){ receipts = receipts.filter(x=>x.id!==r.id); saveAll(); }}); const actions=document.createElement('div'); actions.className='actions'; actions.appendChild(openBtn); actions.appendChild(delBtn); div.appendChild(left); div.appendChild(actions); box.appendChild(div); }); }

function openData(id){ const r = receipts.find(x=>x.id===id); if(!r) return; document.getElementById('no').value=r.no; document.getElementById('tanggal').value=r.tanggal; document.getElementById('terima_dari').value=r.terima_dari; document.getElementById('keterangan').value=r.keterangan; document.getElementById('metode').value=r.metode; document.getElementById('pajak').value=r.pajak; document.getElementById('notes').value=r.notes; const tbody=document.querySelector('#items-table tbody'); tbody.innerHTML=''; (r.items||[]).forEach(it=> addItem(it.desc,it.qty,it.price)); recalc(); window.scrollTo({top:0,behavior:'smooth'}); }
function resetForm(){ document.getElementById('no').value=''; document.getElementById('terima_dari').value=''; document.getElementById('keterangan').value=''; document.getElementById('notes').value=''; document.getElementById('pajak').value=0; const tbody=document.querySelector('#items-table tbody'); tbody.innerHTML=''; addItem(); recalc(); }
function backupJSON(){ const blob=new Blob([JSON.stringify(receipts,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='kwitansi_backup.json'; a.click(); URL.revokeObjectURL(url); }

/* ----------------------- invoice modal & save invoice ----------------------- */
function invoiceAddRow(desc='',qty=1,price=0){ const tbody=document.querySelector('#invoice-items-table tbody'); const tr=document.createElement('tr'); tr.innerHTML=`<td class="small"></td><td><input class="inv-desc" type="text" value="${escapeHtml(desc)}"></td><td><input class="inv-qty" type="number" min=1 value="${qty}"></td><td><input class="inv-price" type="number" min=0 value="${price}"></td><td class="inv-sum">Rp 0</td><td><button class="btn" data-remove>×</button></td>`; tbody.appendChild(tr); attachInvoiceRowEvents(tr); invoiceReindex(); invoiceRecalc(); }
function attachInvoiceRowEvents(tr){ tr.querySelectorAll('input').forEach(i=>i.addEventListener('input', ()=>{ invoiceUpdateRow(tr); invoiceRecalc(); })); const b=tr.querySelector('[data-remove]'); if(b) b.addEventListener('click', ()=>{ tr.remove(); invoiceReindex(); invoiceRecalc(); }); }
function invoiceUpdateRow(tr){ const q=Number(tr.querySelector('.inv-qty').value||0); const p=Number(tr.querySelector('.inv-price').value||0); tr.querySelector('.inv-sum').textContent = formatRp(q*p); }
function invoiceReindex(){ document.querySelectorAll('#invoice-items-table tbody tr').forEach((r,i)=> r.children[0].textContent = i+1); }
function invoiceRecalc(){ let subtotal=0; document.querySelectorAll('#invoice-items-table tbody tr').forEach(r=>{ const q=Number(r.querySelector('.inv-qty').value||0); const p=Number(r.querySelector('.inv-price').value||0); subtotal+=q*p; }); const footer=document.getElementById('invoice-footer'); if(footer) footer.textContent='Subtotal: '+formatRp(subtotal); }
function renderInvoiceModal(){ document.getElementById('invoice_tanggal').value = document.getElementById('tanggal').value || ''; document.getElementById('invoice_to').value = document.getElementById('terima_dari').value || ''; const tbody=document.querySelector('#invoice-items-table tbody'); tbody.innerHTML=''; document.querySelectorAll('#items-table tbody tr').forEach(r=>{ const desc=r.querySelector('.item-desc').value||''; const qty=Number(r.querySelector('.item-qty').value||0); const price=Number(r.querySelector('.item-price').value||0); invoiceAddRow(desc,qty,price); }); invoiceRecalc(); }
function openInvoice(){ renderInvoiceModal(); document.getElementById('invoice-page').classList.add('show'); }
function closeInvoice(){ document.getElementById('invoice-page').classList.remove('show'); }
function printInvoice(){ const date=document.getElementById('invoice_tanggal').value; const fmt=document.getElementById('invoice_date_format').value||'dd-mm-yyyy'; const dateText=formatDateISOTo(date,fmt); const to=escapeHtml(document.getElementById('invoice_to').value||''); let rows=''; let subtotal=0; document.querySelectorAll('#invoice-items-table tbody tr').forEach((r,i)=>{ const desc=escapeHtml(r.querySelector('.inv-desc').value||''); const qty=Number(r.querySelector('.inv-qty').value||0); const price=Number(r.querySelector('.inv-price').value||0); const sum=qty*price; subtotal+=sum; rows+=`<tr><td>${i+1}</td><td>${desc}</td><td>${qty}</td><td>${formatRp(price)}</td><td>${formatRp(sum)}</td></tr>`; }); const kopOn = document.getElementById('kop_toggle')?.value === 'on';
const kopText = document.getElementById('kop')?.innerHTML || '';
const invoiceKopOn = document.getElementById('invoice_kop_toggle')?.value === 'on';
const invoiceKopText = (document.getElementById('invoice_kop')?.value || '').replace(/\n/g,'<br>');
const html=`<!doctype html><html><head><meta charset="utf-8"><title>Invoice</title><style>@page{margin:0;}body{font-family:system-ui;margin:20px}table{width:100%;border-collapse:collapse}td,th{border:1px solid #ccc;padding:6px}</style></head><body>${invoiceKopOn?`<div style="text-align:center;font-weight:700;margin-bottom:12px">${invoiceKopText}</div>`:''}${kopOn?`<div style="text-align:center;font-weight:700;margin-bottom:12px">${kopText}</div>`:''}<div style="display:flex;justify-content:space-between"><div><strong>INVOICE</strong></div><div>No: ${escapeHtml(document.getElementById('no').value||'')}</div></div><div style="margin-top:8px">Tanggal: ${dateText}</div><div style="margin-top:8px">Kepada: ${to}</div><table style="margin-top:12px"><thead><tr><th>No</th><th>Deskripsi</th><th>Qty</th><th>Harga</th><th>Jumlah</th></tr></thead><tbody>${rows}</tbody></table><div style="text-align:right;margin-top:8px;font-weight:700">Subtotal: ${formatRp(subtotal)}</div></body></html>`; const w=window.open('','_blank'); if(!w){ alert('Popup diblokir. Izinkan popup untuk mencetak invoice.'); return; } w.document.open(); w.document.write(html); w.document.close(); w.focus(); setTimeout(()=>{ w.print(); w.close(); },600); }

function saveInvoiceToReceipt(){ const inv = { tanggal: document.getElementById('invoice_tanggal').value || '', format: document.getElementById('invoice_date_format').value || 'dd-mm-yyyy', kepada: document.getElementById('invoice_to').value||'', items: Array.from(document.querySelectorAll('#invoice-items-table tbody tr')).map(r=>({desc:r.querySelector('.inv-desc').value, qty:Number(r.querySelector('.inv-qty').value||0), price:Number(r.querySelector('.inv-price').value||0)})) };
  const currentNo = document.getElementById('no').value || null; if(currentNo){
    const idx = receipts.findIndex(x=>x.no===currentNo);
    if(idx!==-1){ receipts[idx].invoice = inv; saveAll(); alert('Invoice disimpan ke kwitansi.'); return; }
  }
  const rec = { id: Date.now(), no: 'KW-'+Date.now(), tanggal: inv.tanggal, terima_dari: inv.kepada, keterangan: '', metode: 'Tunai', pajak:0, notes:'', items: [], invoice: inv };
  receipts.unshift(rec); saveAll(); alert('Invoice disimpan sebagai entri terpisah.'); }

/* ----------------------- Init ----------------------- */
document.addEventListener('DOMContentLoaded', ()=>{
  receipts = loadReceipts();
  renderList();
  addItem(); recalc();
  document.getElementById('btn-add-item').addEventListener('click', ()=>addItem());
  document.getElementById('btn-save').addEventListener('click', ()=>saveData());
  document.getElementById('btn-new').addEventListener('click', ()=>resetForm());
  document.getElementById('btn-print').addEventListener('click', ()=>exportPDF());
  document.getElementById('btn-download').addEventListener('click', ()=>backupJSON());
  document.getElementById('pajak').addEventListener('input', ()=>recalc());
  document.getElementById('watermark_toggle').addEventListener('change', ()=>renderPreview());
  document.getElementById('watermark_text').addEventListener('input', ()=>renderPreview());
  document.getElementById('date_format').addEventListener('change', ()=>renderPreview());
  document.getElementById('kop_toggle').addEventListener('change', ()=>toggleKop());
  document.getElementById('btn-invoice').addEventListener('click', ()=>openInvoice());
  document.getElementById('invoice-close').addEventListener('click', ()=>closeInvoice());
  document.getElementById('invoice-print').addEventListener('click', ()=>printInvoice());
  document.getElementById('btn-invoice-add-item').addEventListener('click', ()=>invoiceAddRow());
  document.getElementById('invoice-save').addEventListener('click', ()=>saveInvoiceToReceipt());
  toggleKop();
});
</script>
</body>
</html>
