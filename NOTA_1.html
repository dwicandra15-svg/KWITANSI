<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kwitansi Offline</title>

<!-- Library untuk export PDF otomatis -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{--accent:#0b74da;--muted:#666}
body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;line-height:1.4;margin:16px;background:#f5f7fb;color:#222}
.container{max-width:980px;margin:0 auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 6px 20px rgba(2,12,34,.08)}
.panel{padding:12px;border:1px dashed #e6eef9;border-radius:10px;background:#fbfdff}

label{display:block;font-size:13px;color:#666;margin-bottom:6px}
input[type=text], input[type=number], textarea, select, input[type=date]{
  width:100%;padding:8px;border:1px solid #e1e6ef;border-radius:8px;
}

table{width:100%;border-collapse:collapse;margin-top:8px}
table th, table td{padding:8px;border:1px solid #edf2f8;font-size:14px}
table th{background:#f3f8ff}

.btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
.btn-primary{background:#0b74da;color:#fff}
.btn-ghost{background:#fff;border:1px solid #d6e6ff;color:#0b74da}

.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:14px}

.receipts-list{max-height:200px;overflow:auto;border:1px solid #eef3fb;padding:8px;border-radius:8px}
.receipt-item{padding:8px;margin-bottom:6px;background:#fff;border-radius:8px;border:1px solid #f1f6fc;display:flex;justify-content:space-between}

#preview{
  position:relative;background:#fff;padding:20px;border-radius:8px;min-height:160px
}

/* WATERMARK di preview */
#preview #watermark{
  position:absolute;
  top:260px;                  /* >>> POSISI WATERMARK <<< */
  left:50%;
  transform:translate(-50%,0);
  font-size:90px;
  font-weight:900;
  color:rgba(255,0,0,0.15);
  pointer-events:none;
  z-index:0;
}

.signature{height:60px;border-bottom:1px solid #aaa;margin-top:12px}

</style>
</head>

<body>
<div class="container">

<h2 style="margin:0 0 12px">Kwitansi</h2>

<div class="flex" style="display:flex;gap:16px">

    <!-- =========================== -->
    <!-- KOLOM KIRI FORM INPUT       -->
    <!-- =========================== -->
    <div style="flex:1;min-width:360px">

        <div class="panel">

            <div style="display:flex;gap:12px">
                <div style="flex:1">
                    <label>No. Kwitansi</label>
                    <input id="no" type="text" placeholder="AUTO atau isi manual">
                </div>
                <div style="width:160px">
                    <label>Tanggal</label>
                    <input id="tanggal" type="date">
                </div>
            </div>

            <label>Terima dari</label>
            <input id="terima_dari" type="text">

            <label>Untuk pembayaran</label>
            <textarea id="keterangan"></textarea>

            <label>Metode Pembayaran</label>
            <select id="metode">
                <option>Cash</option>
                <option>Transfer</option>
                <option>Cek</option>
            </select>

            <label style="margin-top:10px">Item Pembelian</label>

            <table id="items-table">
                <thead>
                    <tr>
                        <th style="width:6%">#</th>
                        <th>Deskripsi</th>
                        <th style="width:14%">Qty</th>
                        <th style="width:18%">Harga</th>
                        <th style="width:18%">Jumlah</th>
                        <th style="width:6%"></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <button id="btn-add-item" class="btn btn-ghost" style="margin-top:8px">+ Tambah Item</button>

            <div style="display:flex;justify-content:flex-end;margin-top:12px">
                <div class="small">Subtotal &nbsp;</div>
                <div id="subtotal" style="font-weight:700">Rp 0</div>
            </div>

            <div style="display:flex;justify-content:flex-end;margin-top:6px;gap:6px">
                <div class="small">Pajak (%)</div>
                <input id="pajak" type="number" min="0" value="0" style="width:70px">
            </div>

            <div style="display:flex;justify-content:flex-end;margin-top:6px">
                <div class="small">TOTAL &nbsp;</div>
                <div id="total" style="font-weight:900;font-size:18px">Rp 0</div>
            </div>

            <label style="margin-top:10px">Terbilang</label>
            <input id="terbilang" type="text" readonly>

            <label style="margin-top:10px">Catatan</label>
            <textarea id="notes"></textarea>

        </div>

        <!-- KONTROL -->
        <div class="controls">
            <button id="btn-save" class="btn btn-primary">Simpan</button>
            <button id="btn-new" class="btn">Baru</button>

            <!-- Watermark -->
            <select id="watermark_toggle">
                <option value="off">Watermark OFF</option>
                <option value="on">Watermark ON</option>
            </select>

            <input id="watermark_text" type="text" value="LUNAS" style="width:120px">

            <!-- EXPORT PDF OTOMATIS -->
            <button id="btn-print" class="btn btn-ghost">Export PDF</button>

            <button id="btn-download" class="btn">Backup JSON</button>
        </div>

    </div>

    <!-- =========================== -->
    <!-- KOLOM KANAN LIST KWITANSI   -->
    <!-- =========================== -->
    <div style="width:320px">
        <label>Daftar Kwitansi Tersimpan</label>
        <div id="receipts-list" class="receipts-list"></div>
    </div>

</div>


<!-- =========================== -->
<!-- PREVIEW KWITANSI           -->
<!-- =========================== -->
<div style="margin-top:20px;padding:14px;background:#fbfdff;border-radius:10px;border:1px solid #e6f0ff">
    <h3 style="margin:0 0 8px;font-size:16px">Preview</h3>

    <div id="preview"></div>
</div>


</div> <!-- container -->



<!-- ========================================================== -->
<!-- JAVASCRIPT FUNGSI LENGKAP                                 -->
<!-- ========================================================== -->
<script>
/* ----------------------- Helper ----------------------- */
function escapeHtml(s){return String(s||'').replace(/[&"'<>]/g,c=>({"&":"&amp;","\"":"&quot;","'":"&#39;","<":"&lt;",">":"&gt;"}[c]))}
function formatRp(n){return"Rp "+Number(n||0).toLocaleString("id-ID")}

function terbilang(n){
 n=Math.floor(Number(n)||0);
 const s=["","satu","dua","tiga","empat","lima","enam","tujuh","delapan","sembilan","sepuluh","sebelas"];
 function w(x){
  if(x<12)return s[x];
  if(x<20)return w(x-10)+" belas";
  if(x<100)return w(x/10|0)+" puluh "+w(x%10);
  if(x<200)return"seratus "+w(x-100);
  if(x<1000)return w(x/100|0)+" ratus "+w(x%100);
  if(x<2000)return"seribu "+w(x-1000);
  if(x<1e6)return w(x/1e3|0)+" ribu "+w(x%1e3);
  if(x<1e9)return w(x/1e6|0)+" juta "+w(x%1e6);
  return x;
 }
 return w(n).trim();
}

/* ----------------------- Items ----------------------- */
function addItem(desc="",qty=1,price=0){
 let tb=document.querySelector("#items-table tbody");
 let tr=document.createElement("tr");
 tr.innerHTML=`
   <td class="small"></td>
   <td><input class="item-desc" value="${escapeHtml(desc)}"></td>
   <td><input class="item-qty" type="number" min="1" value="${qty}"></td>
   <td><input class="item-price" type="number" min="0" value="${price}"></td>
   <td class="item-sum">Rp 0</td>
   <td><button class="btn" data-remove>x</button></td>
 `;
 tb.appendChild(tr);
 attachEvents(tr);
 reindex();
 recalc();
}

function attachEvents(tr){
 tr.querySelectorAll("input").forEach(i=>i.addEventListener("input",()=>{updateRow(tr);recalc()}));
 tr.querySelector("[data-remove]").onclick=()=>{tr.remove();reindex();recalc()};
}

function updateRow(tr){
 let q=Number(tr.querySelector(".item-qty").value||0);
 let p=Number(tr.querySelector(".item-price").value||0);
 tr.querySelector(".item-sum").textContent=formatRp(q*p);
}

function reindex(){
 document.querySelectorAll("#items-table tbody tr").forEach((r,i)=>r.children[0].textContent=i+1);
}

/* ----------------------- Total ----------------------- */
function recalc(){
 let subtotal=0;
 document.querySelectorAll("#items-table tbody tr").forEach(r=>{
   let q=Number(r.querySelector(".item-qty").value||0);
   let p=Number(r.querySelector(".item-price").value||0);
   subtotal+=q*p;
 });
 document.getElementById("subtotal").textContent=formatRp(subtotal);
 let pajak=Number(document.getElementById("pajak").value||0);
 let total=Math.round(subtotal*(1+pajak/100));
 document.getElementById("total").textContent=formatRp(total);
 document.getElementById("terbilang").value=terbilang(total)+" rupiah";
 renderPreview();
}

/* ----------------------- Preview ----------------------- */
function renderPreview(){
 const p=document.getElementById("preview");
 const no=document.getElementById("no").value;
 const tanggal=document.getElementById("tanggal").value;
 const nama=document.getElementById("terima_dari").value;
 const ket=document.getElementById("keterangan").value;
 const pajak=document.getElementById("pajak").value;
 const notes=document.getElementById("notes").value;
 
 let rows="";
 document.querySelectorAll("#items-table tbody tr").forEach((r,i)=>{
   let desc=r.querySelector(".item-desc").value;
   let qty=r.querySelector(".item-qty").value;
   let price=r.querySelector(".item-price").value;
   let sum=qty*price;
   rows+=`
     <tr>
       <td>${i+1}</td>
       <td>${escapeHtml(desc)}</td>
       <td>${qty}</td>
       <td>${formatRp(price)}</td>
       <td>${formatRp(sum)}</td>
     </tr>
   `;
 });

 let subtotal=document.getElementById("subtotal").textContent;
 let total=document.getElementById("total").textContent;
 let terbil=document.getElementById("terbilang").value;

 let html=`
 <div style="max-width:700px;margin:0 auto;position:relative;z-index:1">

   <div style="display:flex;justify-content:space-between">
     <div>
       <div style="font-size:18px;font-weight:700">KWITANSI</div>
       <div class="small">No: ${escapeHtml(no||"(Otomatis)")}</div>
     </div>
     <div class="small" style="text-align:right">
       Tanggal: ${escapeHtml(tanggal)}<br>
       Metode: ${document.getElementById("metode").value}
     </div>
   </div>

   <div style="margin-top:10px">
     <div class="small">Telah terima dari:</div>
     <div style="font-weight:600">${escapeHtml(nama)}</div>
     <div>Untuk pembayaran: ${escapeHtml(ket)}</div>
   </div>

   <table style="margin-top:12px">
     <thead>
       <tr><th>No</th><th>Deskripsi</th><th>Qty</th><th>Harga</th><th>Jumlah</th></tr>
     </thead>
     <tbody>${rows}</tbody>
   </table>

   <div style="display:flex;justify-content:flex-end;margin-top:10px">
     <div class="small">Subtotal</div>&nbsp;
     <div style="font-weight:700">${subtotal}</div>
   </div>

   <div style="display:flex;justify-content:flex-end">
     <div class="small">Pajak (${pajak}%)</div>&nbsp;
     <div style="font-weight:700">${formatRp(parseInt(total.replace(/[Rp .]/g,"")) - parseInt(subtotal.replace(/[Rp .]/g,"")))}</div>
   </div>

   <div style="display:flex;justify-content:flex-end;margin-top:4px">
     <div class="small">TOTAL</div>&nbsp;
     <div style="font-weight:900;font-size:18px">${total}</div>
   </div>

   <div style="margin-top:10px">Terbilang: <i>${escapeHtml(terbil)}</i></div>

   <div style="display:flex;justify-content:space-between;margin-top:24px">
     <div style="width:60%">
       <div class="small">Catatan:</div>
       <div style="min-height:40px">${escapeHtml(notes||"")}</div>
     </div>

     <div style="width:35%;text-align:center">
       <div class="small">Penerima</div>
       <div class="signature"></div>
       (___________________)
     </div>
   </div>

 </div>`;

 let wm="";
 if(document.getElementById("watermark_toggle").value==="on"){
   wm = `<div id="watermark">${escapeHtml(document.getElementById("watermark_text").value)}</div>`;
 }

 p.innerHTML = html + wm;
}


/* ----------------------- Export PDF OTOMATIS ----------------------- */
async function exportPDF(){
 const { jsPDF } = window.jspdf;
 const preview=document.getElementById("preview");

 // Render ke gambar
 const canvas = await html2canvas(preview, {
   scale:3,
   useCORS:true
 });

 const img = canvas.toDataURL("image/png");
 const pdf = new jsPDF("p","mm","a4");

 const w = 210;
 const h = (canvas.height * w) / canvas.width;

 pdf.addImage(img,"PNG",0,0,w,h);
 pdf.save("kwitansi.pdf");
}


/* ------------------- Storage ------------------- */
let receipts=[];
const KEY="kwitansi_store_v1";

function load(){
 try{
   const raw=localStorage.getItem(KEY);
   receipts=raw?JSON.parse(raw):[];
 }catch(e){receipts=[]}
 renderList();
}

function saveAll(){
 localStorage.setItem(KEY,JSON.stringify(receipts));
 renderList();
}

function saveData(){
 let no=document.getElementById("no").value;
 if(!no) no="KW-"+Date.now();

 receipts.unshift({
   id:Date.now(),
   no:no,
   tanggal:document.getElementById("tanggal").value,
   terima_dari:document.getElementById("terima_dari").value,
   keterangan:document.getElementById("keterangan").value,
   metode:document.getElementById("metode").value,
   pajak:Number(document.getElementById("pajak").value),
   notes:document.getElementById("notes").value,
   items: Array.from(document.querySelectorAll("#items-table tbody tr")).map(r=>({
       desc:r.querySelector(".item-desc").value,
       qty:r.querySelector(".item-qty").value,
       price:r.querySelector(".item-price").value
   }))
 });

 saveAll();
 resetForm();
 alert("Kwitansi tersimpan");
}

function renderList(){
 let box=document.getElementById("receipts-list");
 box.innerHTML="";
 receipts.forEach(r=>{
   let div=document.createElement("div");
   div.className="receipt-item";
   div.innerHTML=`
     <div>
       <div style="font-weight:600">${r.no}</div>
       <div class="small">${r.terima_dari || ""}</div>
     </div>
     <button class="btn" onclick="openData(${r.id})">Buka</button>
   `;
   box.appendChild(div);
 });
}

function openData(id){
 let r=receipts.find(x=>x.id===id);
 if(!r) return;
 document.getElementById("no").value=r.no;
 document.getElementById("tanggal").value=r.tanggal;
 document.getElementById("terima_dari").value=r.terima_dari;
 document.getElementById("keterangan").value=r.keterangan;
 document.getElementById("metode").value=r.metode;
 document.getElementById("pajak").value=r.pajak;
 document.getElementById("notes").value=r.notes;

 let tb=document.querySelector("#items-table tbody");
 tb.innerHTML="";
 r.items.forEach(it=>addItem(it.desc,it.qty,it.price));
 recalc();
 window.scrollTo({top:0,behavior:"smooth"});
}

function resetForm(){
 document.getElementById("no").value="";
 document.getElementById("terima_dari").value="";
 document.getElementById("keterangan").value="";
 document.getElementById("notes").value="";
 document.getElementById("pajak").value=0;

 let tb=document.querySelector("#items-table tbody");
 tb.innerHTML="";
 addItem();
 recalc();
}

/* ------------------- JSON backup ------------------- */
function backupJSON(){
 let blob=new Blob([JSON.stringify(receipts,null,2)],{type:"application/json"});
 let url=URL.createObjectURL(blob);
 let a=document.createElement("a");
 a.href=url;
 a.download="kwitansi_backup.json";
 a.click();
 URL.revokeObjectURL(url);
}

/* ------------------- Init ------------------- */
document.addEventListener("DOMContentLoaded",()=>{

 load();
 addItem();
 recalc();

 document.getElementById("btn-add-item").onclick=()=>addItem();
 document.getElementById("btn-save").onclick=()=>saveData();
 document.getElementById("btn-new").onclick=()=>resetForm();
 document.getElementById("btn-print").onclick=()=>exportPDF();
 document.getElementById("btn-download").onclick=()=>backupJSON();

 document.getElementById("pajak").oninput=()=>recalc();
 document.getElementById("watermark_toggle").onchange=()=>renderPreview();
 document.getElementById("watermark_text").oninput=()=>renderPreview();

});
</script>

</body>
</html>
